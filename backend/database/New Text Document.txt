src/Admindashboard.jsx
import React, { useEffect, useState } from "react";
import axios from "axios";
import { useAuth } from "../context/AuthContext";
import {
  fetchAlerts,
  createAlert,
  updateAlert,
  deleteAlert,
} from "../config/adminApi";

export default function AdminDashboard() {
  const { logout } = useAuth();
  const [view, setView] = useState("alerts");

  // Alerts
  const [alerts, setAlerts] = useState([]);
  const [newAlert, setNewAlert] = useState({ title: "", message: "" });
  const [editIndex, setEditIndex] = useState(null);
  const [editedAlert, setEditedAlert] = useState({});

  // Messages
  const [messages, setMessages] = useState([]);
  const [replyingId, setReplyingId] = useState(null);
  const [replySubject, setReplySubject] = useState("");
  const [replyBody, setReplyBody] = useState("");

  // Reports
  const [reports, setReports] = useState([]);

  // Fire Risk Scan State
  const [scanLoading, setScanLoading] = useState(false);
  const [highRiskDistricts, setHighRiskDistricts] = useState([]);
  const [selectedDistricts, setSelectedDistricts] = useState([]);
  const [alertReasons, setAlertReasons] = useState({});
  const [scanError, setScanError] = useState("");
  const [bulkAlertLoading, setBulkAlertLoading] = useState(false);
  const [bulkAlertResult, setBulkAlertResult] = useState(null);

  useEffect(() => {
    loadAlerts();
    loadMessages();
    loadReports();
  }, []);

  const loadAlerts = () =>
    axios.get("http://localhost:8000/admin/public/alerts")
      .then((res) => setAlerts(res.data))
      .catch(console.error);

  const loadMessages = () =>
    axios
      .get("http://localhost:8000/messages")
      .then((res) => setMessages(res.data))
      .catch(console.error);

  const loadReports = () =>
    axios
      .get("http://localhost:8000/reports")
      .then((res) => setReports(res.data))
      .catch(console.error);

  // Alert CRUD
  const handleCreate = async () => {
    if (!newAlert.forest || !newAlert.district || !newAlert.message)
      return alert("Forest name, district, and message are required");

    // Create alert data with proper structure
    const alertData = {
      title: `üî• Forest Fire Alert: ${newAlert.forest}`,
      message: newAlert.message,
      forest: newAlert.forest,
      district: newAlert.district,
      province: newAlert.province || "Unknown",
      location_details: newAlert.location_details || "Nepal",
      latitude: newAlert.latitude ?? null,
      longitude: newAlert.longitude ?? null,
      risk_level: newAlert.risk_level || "Moderate",
      severity: (newAlert.risk_level || "Moderate").toLowerCase(),
      duration_days: newAlert.duration_days || 3,
      weather_data: {
        temperature: newAlert.temperature || 25,
        humidity: newAlert.humidity || 60,
        wind_speed: 10,
        precipitation: 0
      },
    };

    try {
      const res = await axios.post("http://localhost:8000/admin/test-alerts", alertData);
      setAlerts([...alerts, res.data]);
      setNewAlert({ title: "", message: "" });
      alert("Forest fire alert created successfully!");
    } catch (error) {
      console.error("Create alert error:", error);
      alert("Failed to create alert. Check console for details.");
    }
  };

  const handleDelete = async (id) => {
    if (!window.confirm("Delete this alert?")) return;
    try {
      await axios.delete(`http://localhost:8000/admin/alerts/${id}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem("adminToken")}` }
      });
      setAlerts(alerts.filter((a) => a.id !== id));
    } catch {
      alert("Delete failed");
    }
  };

  const startEdit = (i) => {
    setEditIndex(i);
    setEditedAlert({ ...alerts[i] });
  };

  const cancelEdit = () => {
    setEditIndex(null);
    setEditedAlert({});
  };

  const saveEdit = async (id) => {
    try {
      const res = await axios.put(`http://localhost:8000/admin/alerts/${id}`, {
        title: editedAlert.title,
        message: editedAlert.message,
      }, {
        headers: { Authorization: `Bearer ${localStorage.getItem("adminToken")}` }
      });
      const updated = [...alerts];
      updated[editIndex] = res.data;
      setAlerts(updated);
      cancelEdit();
    } catch {
      alert("Update failed");
    }
  };

  // Reply to user messages
  const sendReply = async (email) => {
    if (!replySubject || !replyBody) return alert("Fill subject & body");
    try {
      await axios.post(
        "http://localhost:8000/admin/reply",
        {
          to_email: email,
          subject: replySubject,
          message: replyBody,
        },
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("adminToken")}`,
          },
        }
      );
      alert("Reply sent");
      setReplyingId(null);
      setReplySubject("");
      setReplyBody("");
    } catch (err) {
      console.error(err);
      alert("Failed to send reply");
    }
  };

  // Update report resolution status
  const handleResolve = async (id, newStatus) => {
    try {
      await axios.put(`http://localhost:8000/reports/${id}/resolve`, {
        resolved: newStatus,
      });
      setReports((prev) =>
        prev.map((r) => (r.id === id ? { ...r, resolved: newStatus } : r))
      );
    } catch (err) {
      console.error(err);
      alert("Failed to update report status.");
    }
  };

  // Run full Nepal scan
  const handleScan = async () => {
    setScanLoading(true);
    setScanError("");
    setHighRiskDistricts([]);
    setSelectedDistricts([]);
    setAlertReasons({});
    try {
      const { data } = await axios.post(
        "http://localhost:8000/admin/test-scan-nepal",
        {}
      );
      setHighRiskDistricts(data.high_risk_districts || []);
    } catch (err) {
      setScanError("Scan failed. See console for details.");
      console.error(err);
    }
    setScanLoading(false);
  };

  // Select/deselect districts
  const toggleDistrict = (district) => {
    setSelectedDistricts((prev) =>
      prev.includes(district)
        ? prev.filter((d) => d !== district)
        : [...prev, district]
    );
  };

  // Set reason for a district
  const handleReasonChange = (district, reason) => {
    setAlertReasons((prev) => ({ ...prev, [district]: reason }));
  };

  // Submit selected districts as alerts
  const handleBulkAlert = async () => {
    setBulkAlertLoading(true);
    setBulkAlertResult(null);
    const alerts = highRiskDistricts
      .filter((d) => selectedDistricts.includes(d.district))
      .map((d) => ({
        title: `üî• Forest Fire Alert: ${d.district}`,
        message: `High forest fire risk detected in ${d.district} forest region.`,
        district: d.district,
        latitude: d.latitude ?? null,
        longitude: d.longitude ?? null,
        risk_level: d.fire_risk,
        severity: (d.fire_risk || "Moderate").toLowerCase(),
        duration_days: 7,
        probability: d.probability,
        weather_data: d.weather_data || d.details,
        precautions: `üå≤ FOREST FIRE ALERT: ${d.district} (${d.province}) - ${d.location_details}

‚ö†Ô∏è CRITICAL PRECAUTIONS:
‚Ä¢ Avoid any open flames, smoking, or burning activities
‚Ä¢ Do not light campfires or use fireworks in forest areas
‚Ä¢ Report any smoke or fire immediately to emergency services
‚Ä¢ Stay away from forest areas during high-risk periods
‚Ä¢ Monitor local weather conditions and wind patterns
‚Ä¢ Follow evacuation orders if issued

üö® EMERGENCY CONTACTS:
‚Ä¢ Forest Department: 1001
‚Ä¢ Fire Brigade: 101
‚Ä¢ Police: 100

This alert is based on current weather conditions including temperature, humidity, wind speed, and precipitation patterns that indicate high forest fire risk.`,
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days from now
        reason: alertReasons[d.district] || "High forest fire risk detected based on weather conditions."
      }));
    try {
      const { data } = await axios.post(
        "http://localhost:8000/admin/test-alerts",
        alerts[0]
      );
      setBulkAlertResult(data.created_alerts);
      setSelectedDistricts([]);
      setAlertReasons({});
      loadAlerts();
    } catch (err) {
      alert("Failed to create alerts. See console.");
      console.error(err);
    }
    setBulkAlertLoading(false);
  };

  // Logout
  const handleLogout = () => {
    logout();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-orange-50 py-12 px-4 sm:px-6 lg:px-8">
      <div style={{ padding: "2rem" }}>
        <h2 style={{ fontWeight: "bold" }}>
          Admin Dashboard
          <button
            onClick={handleLogout}
            style={{
              float: "right",
              background: "#e11d48",
              color: "#fff",
              padding: "6px 12px",
              border: "none",
              borderRadius: 4,
              cursor: "pointer",
            }}
          >
            Logout
          </button>
        </h2>

        {/* View Tabs */}
        <div style={{ marginBottom: "1rem" }}>
          <button
            onClick={() => setView("alerts")}
            style={{
              marginRight: 8,
              padding: "6px 12px",
              background: view === "alerts" ? "#2563eb" : "#e5e7eb",
              color: view === "alerts" ? "#fff" : "#000",
              border: "none",
              borderRadius: 4,
              cursor: "pointer",
            }}
          >
            Alerts
          </button>
          <button
            onClick={() => setView("messages")}
            style={{
              marginRight: 8,
              padding: "6px 12px",
              background: view === "messages" ? "#2563eb" : "#e5e7eb",
              color: view === "messages" ? "#fff" : "#000",
              border: "none",
              borderRadius: 4,
              cursor: "pointer",
            }}
          >
            User Messages
          </button>
          <button
            onClick={() => setView("reports")}
            style={{
              padding: "6px 12px",
              background: view === "reports" ? "#2563eb" : "#e5e7eb",
              color: view === "reports" ? "#fff" : "#000",
              border: "none",
              borderRadius: 4,
              cursor: "pointer",
            }}
          >
            Fire Reports
          </button>
        </div>

        {/* Fire Risk Scan & Alert Creation */}
        <div style={{ marginBottom: 32, padding: 16, border: "1px solid #ddd", borderRadius: 8 }}>
          <h3>Fire Risk Management</h3>
          <div style={{ display: "flex", gap: "12px", marginBottom: "12px" }}>
            <button onClick={handleScan} disabled={scanLoading} style={{ padding: "8px 16px", background: "#2563eb", color: "#fff", border: "none", borderRadius: 4, cursor: "pointer" }}>
              {scanLoading ? "Scanning Forests..." : "üå≤ Scan Nepal Forests"}
            </button>
            <a href="/alerts-management" style={{ padding: "8px 16px", background: "#f59e0b", color: "#fff", border: "none", borderRadius: 4, cursor: "pointer", textDecoration: "none" }}>
              üö® Manage Alerts
            </a>
            <a href="/alerts" style={{ padding: "8px 16px", background: "#10b981", color: "#fff", border: "none", borderRadius: 4, cursor: "pointer", textDecoration: "none" }}>
              üëÅÔ∏è View Public Alerts
            </a>
          </div>
          {scanError && <div style={{ color: "red" }}>{scanError}</div>}
          {highRiskDistricts.length > 0 && (
            <div>
              <p><strong>üå≤ Forest Fire Risk Assessment Complete:</strong> High-risk forest areas detected. Select which forest regions to create alerts for and add specific reasons.</p>
              <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead>
                  <tr>
                    <th></th>
                    <th>Forest Name</th>
                    <th>District</th>
                    <th>Location</th>
                    <th>Temp (¬∞C)</th>
                    <th>Humidity (%)</th>
                    <th>Risk Level</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody>
                  {highRiskDistricts.map((d) => (
                    <tr key={d.forest || d.district} style={{ borderBottom: "1px solid #eee" }}>
                      <td>
                        <input
                          type="checkbox"
                          checked={selectedDistricts.includes(d.forest || d.district)}
                          onChange={() => toggleDistrict(d.forest || d.district)}
                        />
                      </td>
                      <td><strong>{d.forest || d.district}</strong></td>
                      <td><strong>{d.district}</strong></td>
                      <td>
                        <div style={{ fontSize: "12px" }}>
                          <div><strong>{d.province}</strong></div>
                          <div style={{ color: "#666" }}>{d.location_details}</div>
                          <div style={{ color: "#888", fontSize: "10px" }}>
                            üìç {d.latitude?.toFixed(4)}, {d.longitude?.toFixed(4)}
                          </div>
                        </div>
                      </td>
                      <td>{d.weather_data?.temperature || d.details?.temperature}</td>
                      <td>{d.weather_data?.humidity || d.details?.humidity}</td>
                      <td>
                        <span style={{
                          padding: "2px 6px",
                          borderRadius: "3px",
                          fontSize: "12px",
                          color: "white",
                          backgroundColor: d.fire_risk === "High" ? "#dc2626" : d.fire_risk === "Moderate" ? "#f59e0b" : "#10b981"
                        }}>
                          {d.fire_risk}
                        </span>
                      </td>
                      <td>
                        <input
                          type="text"
                          placeholder="Reason for alert"
                          value={alertReasons[d.forest || d.district] || ""}
                          onChange={(e) => handleReasonChange(d.forest || d.district, e.target.value)}
                          style={{ width: 180 }}
                        />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <button
                onClick={handleBulkAlert}
                disabled={bulkAlertLoading || selectedDistricts.length === 0}
                style={{ marginTop: 12, padding: "8px 16px", background: "#e11d48", color: "#fff", border: "none", borderRadius: 4, cursor: "pointer" }}
              >
                {bulkAlertLoading ? "Publishing Forest Alerts..." : `üå≤ Publish ${selectedDistricts.length} Forest Fire Alert(s)`}
              </button>
              {bulkAlertResult && (
                <div style={{ color: "green", marginTop: 8 }}>
                  üå≤ {bulkAlertResult.length} forest fire alert(s) published successfully!
                </div>
              )}
            </div>
          )}
        </div>

        {/* Alerts Panel */}
        {view === "alerts" && (
          <>
            <div style={{ marginBottom: "2rem" }}>
              <h4>Create Manual Alert</h4>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "12px", marginBottom: "12px" }}>
                <input
                  placeholder="Forest Name (e.g., Chitwan National Park)"
                  value={newAlert.forest || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, forest: e.target.value })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  placeholder="District (e.g., Chitwan)"
                  value={newAlert.district || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, district: e.target.value })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  placeholder="Province (e.g., Bagmati)"
                  value={newAlert.province || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, province: e.target.value })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  placeholder="Location Details"
                  value={newAlert.location_details || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, location_details: e.target.value })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  type="number"
                  step="0.0001"
                  placeholder="Latitude"
                  value={newAlert.latitude || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, latitude: parseFloat(e.target.value) || 0 })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  type="number"
                  step="0.0001"
                  placeholder="Longitude"
                  value={newAlert.longitude || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, longitude: parseFloat(e.target.value) || 0 })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  type="number"
                  step="0.1"
                  placeholder="Temperature (¬∞C)"
                  value={newAlert.temperature || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, temperature: parseFloat(e.target.value) || 0 })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <input
                  type="number"
                  step="0.1"
                  placeholder="Humidity (%)"
                  value={newAlert.humidity || ""}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, humidity: parseFloat(e.target.value) || 0 })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
                <select
                  value={newAlert.risk_level || "Moderate"}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, risk_level: e.target.value })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                >
                  <option value="Low">Low Risk</option>
                  <option value="Moderate">Moderate Risk</option>
                  <option value="High">High Risk</option>
                </select>
                <input
                  type="number"
                  min="1"
                  max="30"
                  placeholder="Duration (days)"
                  value={newAlert.duration_days || 3}
                  onChange={(e) =>
                    setNewAlert({ ...newAlert, duration_days: parseInt(e.target.value) || 3 })
                  }
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ddd" }}
                />
              </div>
              <textarea
                placeholder="Alert Message/Precautions (e.g., High fire risk due to dry conditions. Avoid open flames, report any smoke immediately.)"
                value={newAlert.message || ""}
                onChange={(e) =>
                  setNewAlert({ ...newAlert, message: e.target.value })
                }
                style={{ width: "100%", padding: "8px", borderRadius: "4px", border: "1px solid #ddd", minHeight: "80px" }}
              />
              <button
                onClick={handleCreate}
                style={{ marginTop: "8px", padding: "8px 16px", background: "#dc2626", color: "white", border: "none", borderRadius: "4px", cursor: "pointer" }}
              >
                üö® Create Forest Fire Alert
              </button>
            </div>

            <hr />
            <h3>Existing Alerts</h3>
            {alerts.length === 0 ? (
              <p>No alerts yet.</p>
            ) : (
              alerts.map((alert, i) => (
                <div
                  key={alert.id}
                  style={{
                    marginBottom: "1rem",
                    padding: "1rem",
                    border: "1px solid #ccc",
                    borderRadius: 6,
                  }}
                >
                  {editIndex === i ? (
                    <>
                      <input
                        value={editedAlert.title}
                        onChange={(e) =>
                          setEditedAlert({
                            ...editedAlert,
                            title: e.target.value,
                          })
                        }
                        style={{ marginBottom: 6 }}
                      />
                      <br />
                      <input
                        value={editedAlert.message}
                        onChange={(e) =>
                          setEditedAlert({
                            ...editedAlert,
                            message: e.target.value,
                          })
                        }
                        style={{ marginBottom: 6, width: "70%" }}
                      />
                      <br />
                      <button onClick={() => saveEdit(alert.id)}>Save</button>{" "}
                      <button onClick={cancelEdit}>Cancel</button>
                    </>
                  ) : (
                    <>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: "8px" }}>
                        <div>
                          <strong style={{ fontSize: "16px", color: "#dc2626" }}>{alert.title}</strong>
                          <div style={{ fontSize: "12px", color: "#666", marginTop: "4px" }}>
                            {alert.forest && <span>üå≤ <strong>Forest:</strong> {alert.forest} | </span>}
                            {alert.district && <span>üìç <strong>District:</strong> {alert.district} | </span>}
                            {alert.province && <span>üèõÔ∏è <strong>Province:</strong> {alert.province} | </span>}
                            {alert.risk_level && (
                              <span style={{
                                padding: "2px 6px",
                                borderRadius: "3px",
                                fontSize: "10px",
                                color: "white",
                                backgroundColor: alert.risk_level === "High" ? "#dc2626" : alert.risk_level === "Moderate" ? "#f59e0b" : "#10b981"
                              }}>
                                {alert.risk_level} Risk
                              </span>
                            )}
                          </div>
                          {alert.latitude && alert.longitude && (
                            <div style={{ fontSize: "11px", color: "#888", marginTop: "2px" }}>
                              üìç Coordinates: {alert.latitude.toFixed(4)}, {alert.longitude.toFixed(4)}
                            </div>
                          )}
                          {alert.weather_data && (
                            <div style={{ fontSize: "11px", color: "#888", marginTop: "2px" }}>
                              üå°Ô∏è Temp: {alert.weather_data.temperature}¬∞C | üíß Humidity: {alert.weather_data.humidity}%
                            </div>
                          )}
                        </div>
                        <div>
                          <button
                            onClick={() => startEdit(i)}
                            style={{ padding: "4px 8px", background: "#2563eb", color: "white", border: "none", borderRadius: "3px", fontSize: "12px", marginRight: "4px" }}
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => handleDelete(alert.id)}
                            style={{ padding: "4px 8px", background: "#dc2626", color: "white", border: "none", borderRadius: "3px", fontSize: "12px" }}
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                      <p style={{ marginTop: "8px", lineHeight: "1.4" }}>{alert.message}</p>
                    </>
                  )}
                </div>
              ))
            )}
          </>
        )}

        {/* User Messages Panel */}
        {view === "messages" && (
          <>
            <h3>User Messages</h3>
            {messages.length === 0 ? (
              <p>No user messages yet.</p>
            ) : (
              messages.map((msg) => (
                <div
                  key={msg.id}
                  style={{
                    marginBottom: "1rem",
                    padding: "1rem",
                    border: "1px solid #ccc",
                    borderRadius: 6,
                    background: "#f3f4f6",
                  }}
                >
                  <p>
                    <strong>{msg.name}</strong> ({msg.email})
                  </p>
                  <p>
                    <strong>Subject:</strong> {msg.subject}
                  </p>
                  <p>{msg.message}</p>

                  {replyingId === msg.id ? (
                    <div style={{ marginTop: "0.5rem" }}>
                      <input
                        placeholder="Reply Subject"
                        value={replySubject}
                        onChange={(e) => setReplySubject(e.target.value)}
                        style={{ width: "100%", marginBottom: 6 }}
                      />
                      <textarea
                        placeholder="Reply Message"
                        value={replyBody}
                        onChange={(e) => setReplyBody(e.target.value)}
                        style={{ width: "100%", height: 100, marginBottom: 6 }}
                      />
                      <button onClick={() => sendReply(msg.email)}>
                        Send Reply
                      </button>{" "}
                      <button onClick={() => setReplyingId(null)}>Cancel</button>
                    </div>
                  ) : (
                    <button onClick={() => setReplyingId(msg.id)}>Reply</button>
                  )}
                </div>
              ))
            )}
          </>
        )}

        {/* Fire Reports Panel */}
        {view === "reports" && (
          <>
            <h3>Submitted Wildfire Reports</h3>
            {reports.length === 0 ? (
              <p>No reports submitted yet.</p>
            ) : (
              <ul>
                {reports.map((r) => (
                  <li
                    key={r.id}
                    style={{
                      border: "1px solid #ccc",
                      padding: "10px",
                      marginBottom: "10px",
                      backgroundColor: r.resolved ? "#e5e7eb" : "#fff7ed",
                      opacity: r.resolved ? 0.6 : 1,
                    }}
                  >
                    <strong>{r.name}</strong> reported on{" "}
                    <strong>{r.fire_date}</strong>
                    <br />
                    <strong>Email:</strong> {r.email}
                    <br />
                    <strong>Province:</strong> {r.province},{" "}
                    <strong>District:</strong> {r.district}
                    <br />
                    <strong>Location:</strong> {r.location_details}
                    <br />
                    <strong>Description:</strong> {r.description}
                    <br />
                    <strong>Status:</strong>{" "}
                    <span
                      style={{
                        color: r.resolved ? "green" : "red",
                        fontWeight: "bold",
                      }}
                    >
                      {r.resolved ? "Resolved" : "Pending"}
                    </span>
                    <br />
                    <button
                      onClick={() => handleResolve(r.id, !r.resolved)}
                      style={{
                        marginTop: 6,
                        backgroundColor: r.resolved ? "#d97706" : "#10b981",
                        color: "#fff",
                        border: "none",
                        padding: "6px 10px",
                        borderRadius: 4,
                        cursor: "pointer",
                      }}
                    >
                      {r.resolved ? "Mark Unresolved" : "Mark Resolved"}
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </>
        )}
      </div>
    </div>
  );
}


src/Alerts.jsx
import React, { useState, useEffect } from "react";
import axios from "axios";
import { MapContainer, TileLayer, Marker, Popup } from "react-leaflet";
import "leaflet/dist/leaflet.css";

export default function Alerts() {
  const [alerts, setAlerts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [showMap, setShowMap] = useState(false);
  const [filterStatus, setFilterStatus] = useState("active");

  useEffect(() => {
    fetchAlerts();
  }, []);

  const fetchAlerts = async () => {
    try {
      const { data } = await axios.get("http://localhost:8000/admin/public/alerts");
      setAlerts(data);
    } catch (err) {
      console.error("Fetch alerts error:", err);
      setError("Failed to fetch alerts");
    } finally {
      setLoading(false);
    }
  };

  const getRiskColor = (risk) => {
    switch (risk) {
      case "High": return "#dc2626";
      case "Moderate": return "#f59e0b";
      case "Low": return "#10b981";
      default: return "#6b7280";
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "active": return "#10b981";
      case "expired": return "#6b7280";
      case "cancelled": return "#dc2626";
      default: return "#6b7280";
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleString();
  };

  const filteredAlerts = alerts.filter(alert => {
    if (filterStatus === "all") return true;
    return alert.status === filterStatus;
  });

  if (loading) {
    return (
      <div className="p-6 max-w-7xl mx-auto">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading alerts...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 max-w-7xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-red-800">üö® Fire Alerts</h1>
        <div className="flex gap-4">
          <select
            value={filterStatus}
            onChange={(e) => setFilterStatus(e.target.value)}
            className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
          >
            <option value="active">Active Alerts</option>
            <option value="all">All Alerts</option>
            <option value="expired">Expired Alerts</option>
            <option value="cancelled">Cancelled Alerts</option>
          </select>
          <button
            onClick={() => setShowMap(!showMap)}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            {showMap ? "üìã Show List" : "üó∫Ô∏è Show Map"}
          </button>
        </div>
      </div>

      {error && (
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
          {error}
        </div>
      )}

      {/* Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-blue-600">{alerts.length}</div>
          <div className="text-sm text-gray-600">Total Alerts</div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-green-600">
            {alerts.filter(a => a.status === "active").length}
          </div>
          <div className="text-sm text-gray-600">Active Alerts</div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-red-600">
            {alerts.filter(a => a.risk_level === "High").length}
          </div>
          <div className="text-sm text-gray-600">High Risk Alerts</div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-yellow-600">
            {alerts.filter(a => a.risk_level === "Moderate").length}
          </div>
          <div className="text-sm text-gray-600">Moderate Risk Alerts</div>
        </div>
      </div>

      {showMap ? (
        /* Map View */
        <div className="bg-white shadow-lg rounded-lg p-6">
          <h2 className="text-xl font-semibold mb-4">üó∫Ô∏è Alerts Map</h2>
          <div className="h-96 rounded-lg overflow-hidden">
            <MapContainer
              center={[28.4, 84.1]}
              zoom={7}
              style={{ height: "100%", width: "100%" }}
            >
              <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />

              {filteredAlerts.map((alert) => (
                <Marker
                  key={alert.id}
                  position={[alert.latitude, alert.longitude]}
                >
                  <Popup>
                    <div className="max-w-xs">
                      <h4 className="font-semibold text-lg">{alert.title}</h4>
                      <p className="text-sm text-gray-600 mb-2">{alert.district}</p>
                      <div className="flex gap-2 mb-2">
                        <span
                          className="px-2 py-1 rounded text-xs text-white"
                          style={{ backgroundColor: getRiskColor(alert.risk_level) }}
                        >
                          {alert.risk_level} Risk
                        </span>
                        <span
                          className="px-2 py-1 rounded text-xs text-white"
                          style={{ backgroundColor: getStatusColor(alert.status) }}
                        >
                          {alert.status}
                        </span>
                      </div>
                      <p className="text-sm mb-2">{alert.message}</p>
                      <div className="bg-yellow-50 p-2 rounded text-xs">
                        <strong>‚ö†Ô∏è Precautions:</strong> {alert.precautions}
                      </div>
                      <p className="text-xs text-gray-500 mt-2">
                        Created: {formatDate(alert.created_at)}
                      </p>
                    </div>
                  </Popup>
                </Marker>
              ))}
            </MapContainer>
          </div>
        </div>
      ) : (
        /* List View */
        <div className="bg-white shadow-lg rounded-lg p-6">
          <h2 className="text-xl font-semibold mb-4">
            üìã {filterStatus === "all" ? "All" : filterStatus.charAt(0).toUpperCase() + filterStatus.slice(1)} Alerts
          </h2>

          {filteredAlerts.length === 0 ? (
            <div className="text-center py-8">
              <div className="text-4xl mb-4">üö®</div>
              <p className="text-gray-600">
                {filterStatus === "active"
                  ? "No active alerts at the moment. Stay safe!"
                  : `No ${filterStatus} alerts found.`
                }
              </p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredAlerts.map((alert) => (
                <div key={alert.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="text-lg font-semibold">{alert.title}</h3>
                      <p className="text-sm text-gray-600">{alert.district}</p>
                    </div>
                    <div className="flex gap-2">
                      <span
                        className="px-2 py-1 rounded text-sm font-medium text-white"
                        style={{ backgroundColor: getRiskColor(alert.risk_level) }}
                      >
                        {alert.risk_level} Risk
                      </span>
                      <span
                        className="px-2 py-1 rounded text-sm font-medium text-white"
                        style={{ backgroundColor: getStatusColor(alert.status) }}
                      >
                        {alert.status}
                      </span>
                    </div>
                  </div>

                  <p className="text-gray-700 mb-3">{alert.message}</p>

                  <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">
                    <h4 className="font-medium text-sm mb-2">‚ö†Ô∏è Safety Precautions:</h4>
                    <p className="text-sm text-gray-700">{alert.precautions}</p>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-3">
                    <div>üå°Ô∏è {alert.weather_data?.temperature}¬∞C</div>
                    <div>üíß {alert.weather_data?.humidity}% humidity</div>
                    <div>üí® {alert.weather_data?.wind_speed} km/h wind</div>
                    <div>üìä {(alert.probability * 100).toFixed(1)}% fire risk</div>
                  </div>

                  <div className="text-xs text-gray-500">
                    Created: {formatDate(alert.created_at)}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Safety Information */}
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6">
        <h3 className="text-lg font-semibold text-blue-800 mb-3">üõ°Ô∏è Fire Safety Tips</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700">
          <div>
            <h4 className="font-medium mb-2">During High Fire Risk:</h4>
            <ul className="space-y-1">
              <li>‚Ä¢ Avoid open flames and smoking</li>
              <li>‚Ä¢ Don't burn waste or agricultural debris</li>
              <li>‚Ä¢ Keep fire extinguishers ready</li>
              <li>‚Ä¢ Monitor local weather conditions</li>
            </ul>
          </div>
          <div>
            <h4 className="font-medium mb-2">Emergency Contacts:</h4>
            <ul className="space-y-1">
              <li>‚Ä¢ Fire Department: 101</li>
              <li>‚Ä¢ Police: 100</li>
              <li>‚Ä¢ Emergency: 112</li>
              <li>‚Ä¢ Forest Department: 01-4XXXXXX</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
} 


src/AlertsManagement.jsx
import React, { useState, useEffect } from "react";
import axios from "axios";
import { useAuth } from "../context/AuthContext";
import { MapContainer, TileLayer, Marker, Popup } from "react-leaflet";
import "leaflet/dist/leaflet.css";
import { ToastContainer, toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

export default function AlertsManagement() {
  const { logout } = useAuth();
  const [alerts, setAlerts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [editingAlert, setEditingAlert] = useState(null);
  const [showMap, setShowMap] = useState(false);

  useEffect(() => {
    fetchAlerts();
  }, []);

  const fetchAlerts = async () => {
    try {
      const token = localStorage.getItem("adminToken");
      const { data } = await axios.get("http://localhost:8000/alerts", {
        headers: { Authorization: `Bearer ${token}` }
      });
      setAlerts(data);
    } catch (err) {
      console.error("Fetch alerts error:", err);
      setError("Failed to fetch alerts");
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteAlert = async (alertId) => {
    if (!window.confirm("Are you sure you want to delete this alert?")) {
      return;
    }

    try {
      const token = localStorage.getItem("adminToken");
      await axios.delete(`http://localhost:8000/alerts/${alertId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      setAlerts(alerts.filter(alert => alert.id !== alertId));
    } catch (err) {
      console.error("Delete alert error:", err);
      setError("Failed to delete alert");
    }
  };

  const handleUpdateAlert = async (alertId, updatedData) => {
    try {
      const token = localStorage.getItem("adminToken");
      await axios.put(`http://localhost:8000/alerts/${alertId}`, updatedData, {
        headers: { Authorization: `Bearer ${token}` }
      });

      setAlerts(alerts.map(alert =>
        alert.id === alertId ? { ...alert, ...updatedData } : alert
      ));
      setEditingAlert(null);
    } catch (err) {
      console.error("Update alert error:", err);
      setError("Failed to update alert");
    }
  };

  const handleCreateAlert = async (alertData) => {
    try {
      const token = localStorage.getItem("adminToken");
      await axios.post("http://localhost:8000/alerts", alertData, {
        headers: { Authorization: `Bearer ${token}` }
      });
      toast.success("Alert created!");
      fetchAlerts(); // refresh list
    } catch (err) {
      toast.error("Failed to create alert");
    }
  };

  const getRiskColor = (risk) => {
    switch (risk) {
      case "High": return "#dc2626";
      case "Moderate": return "#f59e0b";
      case "Low": return "#10b981";
      default: return "#6b7280";
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "active": return "#10b981";
      case "expired": return "#6b7280";
      case "cancelled": return "#dc2626";
      default: return "#6b7280";
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleString();
  };

  const handleLogout = () => {
    logout();
  };

  if (loading) {
    return (
      <div className="p-6 max-w-7xl mx-auto">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading alerts...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 max-w-7xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-red-800">üö® Fire Alerts Management</h1>
        <div className="flex gap-4">
          <button
            onClick={() => setShowMap(!showMap)}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            {showMap ? "üìã Show List" : "üó∫Ô∏è Show Map"}
          </button>
          <button
            onClick={handleLogout}
            className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
          >
            Logout
          </button>
        </div>
      </div>

      {error && (
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
          {error}
        </div>
      )}

      {/* Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-blue-600">{alerts.length}</div>
          <div className="text-sm text-gray-600">Total Alerts</div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-green-600">
            {alerts.filter(a => a.status === "active").length}
          </div>
          <div className="text-sm text-gray-600">Active Alerts</div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-red-600">
            {alerts.filter(a => a.risk_level === "High").length}
          </div>
          <div className="text-sm text-gray-600">High Risk Alerts</div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-yellow-600">
            {alerts.filter(a => a.risk_level === "Moderate").length}
          </div>
          <div className="text-sm text-gray-600">Moderate Risk Alerts</div>
        </div>
      </div>

      {showMap ? (
        /* Map View */
        <div className="bg-white shadow-lg rounded-lg p-6">
          <h2 className="text-xl font-semibold mb-4">üó∫Ô∏è Alerts Map</h2>
          <div className="h-96 rounded-lg overflow-hidden">
            <MapContainer
              center={[28.4, 84.1]}
              zoom={7}
              style={{ height: "100%", width: "100%" }}
            >
              <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />

              {alerts.map((alert) => (
                <Marker
                  key={alert.id}
                  position={[alert.latitude, alert.longitude]}
                >
                  <Popup>
                    <div className="max-w-xs">
                      <h4 className="font-semibold text-lg">{alert.title}</h4>
                      <p className="text-sm text-gray-600 mb-2">{alert.district}</p>
                      <div className="flex gap-2 mb-2">
                        <span
                          className="px-2 py-1 rounded text-xs text-white"
                          style={{ backgroundColor: getRiskColor(alert.risk_level) }}
                        >
                          {alert.risk_level} Risk
                        </span>
                        <span
                          className="px-2 py-1 rounded text-xs text-white"
                          style={{ backgroundColor: getStatusColor(alert.status) }}
                        >
                          {alert.status}
                        </span>
                      </div>
                      <p className="text-sm mb-2">{alert.message}</p>
                      <p className="text-xs text-gray-500">
                        Created: {formatDate(alert.created_at)}
                      </p>
                    </div>
                  </Popup>
                </Marker>
              ))}
            </MapContainer>
          </div>
        </div>
      ) : (
        /* List View */
        <div className="bg-white shadow-lg rounded-lg p-6">
          <h2 className="text-xl font-semibold mb-4">üìã All Alerts</h2>

          {alerts.length === 0 ? (
            <div className="text-center py-8">
              <div className="text-4xl mb-4">üö®</div>
              <p className="text-gray-600">No alerts found. Run a Nepal scan to create alerts.</p>
            </div>
          ) : (
            <div className="space-y-4 max-h-96 overflow-y-auto">
              {alerts.map((alert) => (
                <div key={alert.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                  {editingAlert?.id === alert.id ? (
                    /* Edit Mode */
                    <div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Title
                          </label>
                          <input
                            type="text"
                            value={editingAlert.title}
                            onChange={(e) => setEditingAlert({
                              ...editingAlert,
                              title: e.target.value
                            })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Status
                          </label>
                          <select
                            value={editingAlert.status}
                            onChange={(e) => setEditingAlert({
                              ...editingAlert,
                              status: e.target.value
                            })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                          >
                            <option value="active">Active</option>
                            <option value="expired">Expired</option>
                            <option value="cancelled">Cancelled</option>
                          </select>
                        </div>
                      </div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Precautions
                        </label>
                        <textarea
                          value={editingAlert.precautions}
                          onChange={(e) => setEditingAlert({
                            ...editingAlert,
                            precautions: e.target.value
                          })}
                          rows={3}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                        />
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleUpdateAlert(alert.id, editingAlert)}
                          className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                        >
                          Save
                        </button>
                        <button
                          onClick={() => setEditingAlert(null)}
                          className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    /* View Mode */
                    <div>
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <h3 className="text-lg font-semibold">{alert.title}</h3>
                          <p className="text-sm text-gray-600">{alert.district}</p>
                        </div>
                        <div className="flex gap-2">
                          <span
                            className="px-2 py-1 rounded text-sm font-medium text-white"
                            style={{ backgroundColor: getRiskColor(alert.risk_level) }}
                          >
                            {alert.risk_level} Risk
                          </span>
                          <span
                            className="px-2 py-1 rounded text-sm font-medium text-white"
                            style={{ backgroundColor: getStatusColor(alert.status) }}
                          >
                            {alert.status}
                          </span>
                        </div>
                      </div>

                      <p className="text-gray-700 mb-3">{alert.message}</p>

                      <div className="bg-gray-50 p-3 rounded mb-3">
                        <h4 className="font-medium text-sm mb-2">‚ö†Ô∏è Precautions:</h4>
                        <p className="text-sm text-gray-600">{alert.precautions}</p>
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-3">
                        <div>üå°Ô∏è {alert.weather_data?.temperature}¬∞C</div>
                        <div>üíß {alert.weather_data?.humidity}%</div>
                        <div>üí® {alert.weather_data?.wind_speed} km/h</div>
                        <div>üìä {(alert.probability * 100).toFixed(1)}% risk</div>
                      </div>

                      <div className="flex justify-between items-center">
                        <div className="text-xs text-gray-500">
                          Created: {formatDate(alert.created_at)}
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setEditingAlert(alert)}
                            className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => handleDeleteAlert(alert.id)}
                            className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      <ToastContainer position="top-center" autoClose={2000} />
    </div>
  );
}


Components/RequireAdmin.jsx

import { Navigate } from "react-router-dom";
import { useAuth } from "../context/AuthContext";

export default function RequireAdmin({ children }) {
  const { isAuthenticated, userRole } = useAuth();

  if (!isAuthenticated || userRole !== 'admin') {
    return <Navigate to="/login" replace />;
  }

  return children;
}



